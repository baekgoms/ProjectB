<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="answer">

	<!-- resultType으로 리턴
		 parameterType DAO에서 가지고 오는 타입 -->
	<update id="updateState" parameterType="int">
		update answer set state = state + 1 where petitionNum=#{petitionNum}
	</update>

	<insert id ="insertArticle" parameterType="answerDTO">
		insert into answer(num,petitionNum,state,content,answerLink,name,department,answerDate,id) 
		values(AnswerNum_seq.nextval, #{petitionNum}, #{state}, #{content}, #{answerLink},#{name},#{department},
		sysdate, #{id})
	</insert>
	
	
	<select id ="getArticleCount" resultType="int" parameterType="map">
		select count(*) from answer A 
			INNER JOIN petition B ON A.petitionNum = B.num
		where A.state = #{state} and A.department = #{department} 
		<if test="category != null and category != '' and category != 0">
			AND A.category = #{category}
		</if>
		<if test="keyword != null and keyword != ''">
			AND B.title LIKE '%' || #{keyword} || '%'
		</if>
	</select>	

	<select id="getCategoryList" resultType="CategoryDTO" >
		select * from category 
	</select>

	<select id="getArticleAll" resultType="answerDTO" parameterType="map">
		select * from (select num, petitionNum, state, category, content, answerLink, name, department, answerDate, recommend, 
		opposite, addition, id, rownum r from(select A.* from answer A
			INNER JOIN petition B ON A.petitionNum = B.num
		where A.department = #{department}
		and A.state = #{state}
		<if test="category != null and category != '' and category != 0">
			AND A.category = #{category}
		</if>
		<if test="keyword != null and keyword != ''">
			AND B.title LIKE '%' || #{keyword} || '%'
		</if>
		<if test="sort != null and sort != ''">
			<choose>
				<when test="sort == 1">
				<!-- 최신순 -->
				ORDER BY B.num DESC
				</when>
				<when test="sort == 2">
				<!-- 동의순 -->
				ORDER BY B.petition DESC
				</when>
			</choose>
		</if>
		)
		) where r <![CDATA[>=]]> #{startRow} and r <![CDATA[<=]]>#{endRow}
	</select>
	

	
	<select id="getPetitionInfo" resultType="petitionDTO" parameterType="int">
      select * from petition where num = #{petitionNum} 
    </select>
    
    <select id = "getAnswerByRecommends" resultType="answerDTO" parameterType="map">
    select * from (select num, petitionNum, state, category, content, answerLink,
		name, department, answerDate, recommend, opposite, addition, id, rownum r
		from (select * from answer order by recommend desc, num asc)
		order by recommend desc, num asc)
		where r <![CDATA[>=]]> #{ startRow } and r <![CDATA[<=]]>#{ endRow }
		
		<if test="sort == 1">
			and answerDate >= sysdate - 7
		</if>
		
		<if test="sort == 2">
			and answerDate >= add_months(sysdate, -1)
		</if>
		
		<if test="sort == 3">
			and answerDate >= add_months(sysdate, -6)
		</if>
		
		<if test="sort == 4">
			and answerDate >= add_months(sysdate, -12)
		</if>
    </select>
    
    <select id = "getAnswerByOpposites" resultType="answerDTO" parameterType="map">
	    select * from (select num, petitionNum, state, category, content, answerLink,
			name, department, answerDate, recommend, opposite, addition, id, rownum r
			from (select * from answer order by opposite desc, num asc)
			order by opposite desc, num asc)
			where r <![CDATA[>=]]> #{ startRow } and r <![CDATA[<=]]>#{ endRow }
			
		<if test="sort == 1">
			and answerDate >= sysdate - 7
		</if>
		
		<if test="sort == 2">
			and answerDate >= add_months(sysdate, -1)
		</if>
		
		<if test="sort == 3">
			and answerDate >= add_months(sysdate, -6)
		</if>
		
		<if test="sort == 4">
			and answerDate >= add_months(sysdate, -12)
		</if>
    </select>
        
    <select id = "getAnswerByAdditions" resultType="answerDTO" parameterType="map">
	    select * from (select num, petitionNum, state, category, content, answerLink,
			name, department, answerDate, recommend, opposite, addition, id, rownum r
			from (select * from answer order by addition desc, num asc)
			order by addition desc, num asc)
			where r <![CDATA[>=]]> #{ startRow } and r <![CDATA[<=]]>#{ endRow }
			
		<if test="sort == 1">
			and answerDate >= sysdate - 7
		</if>
		
		<if test="sort == 2">
			and answerDate >= add_months(sysdate, -1)
		</if>
		
		<if test="sort == 3">
			and answerDate >= add_months(sysdate, -6)
		</if>
		
		<if test="sort == 4">
			and answerDate >= add_months(sysdate, -12)
		</if>
    </select>



	<!-- 답변 완료된 청원 게시판     ########### 보배 ################-->
	
	<select id="completedAnswer" resultType="AnswerDTO" parameterType="map">
		select * from (select num, petitionNum, state, category, content, answerLink, name, department, answerDate, recommend, 
		opposite, addition, id, rownum r from(select*from answer where state= #{state} order by num desc)order by num desc)
		where r <![CDATA[>=]]> #{startRow} and r <![CDATA[<=]]>#{endRow}
	</select>
	
	<select id="completedAnswerCount" resultType="int" parameterType="int">
		select count(*) from answer where state=#{state}
	</select>
	
	<select id="getInfobyNum" resultType="petitionDTO" parameterType="int">
		select*from petition where num = #{num}
	</select>
	
	

	
</mapper>

